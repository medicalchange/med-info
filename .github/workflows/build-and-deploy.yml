name: Build and Deploy Jekyll Site

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'
          bundler-cache: true
          working-directory: aharrismd

      - name: Build site
        run: make build

      - name: Verify build output
        run: |
          test -f _site/index.html
          test -f _site/assets/main.css
          test -f _site/assets/pdfs/Counselling-Options.pdf

      - name: Verify internal PDF links
        run: |
          python3 - <<'PY'
          import re
          import sys
          from pathlib import Path
          from urllib.parse import unquote

          site = Path("_site")
          base = "/med-info/assets/pdfs/"
          missing = []

          for html in site.rglob("*.html"):
              text = html.read_text(encoding="utf-8")
              for href in re.findall(r'href="([^"]+)"', text):
                  if href.startswith(base):
                      rel = unquote(href[len(base):])
                      target = site / "assets" / "pdfs" / rel
                      if not target.exists():
                          missing.append((str(html), href))

          if missing:
              print("Missing internal PDF targets:")
              for html, href in missing:
                  print(f"- {html}: {href}")
              sys.exit(1)

          print("Internal PDF links verified.")
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    runs-on: ubuntu-latest
    needs: build

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
